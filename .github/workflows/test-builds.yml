name: Test Pull Request Builds

on:
  push:
    # branches: master
  pull_request:
    # branches: master
  
jobs:
  linux-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Start CentOS 7 image
        run: |
          docker run --detach -t \
            --name $GITHUB_SHA \
            htcondor/nmi-zdev:x86_64_CentOS7-09040001

      - name: Fetch sources
        run: |
          docker exec $GITHUB_SHA \
            /bin/bash -xc \
              "git clone https://github.com/htcondor/htcondor.git"
      
      - name: Build packages and extract tarballs
        run: |
          docker exec $GITHUB_SHA \
            /bin/bash -xc \
              "mkdir work &&
              cd work &&
              ../htcondor/build-on-linux.sh ../htcondor &&
              ../htcondor/nmi_tools/glue/build/make-tarball-from-rpms ."

      - name: CentOS 7 build CI
        env:
          UW_BUILD: ON
          PROPER: OFF
          VOMS: ON
          GLOBUS: ON
          SCITOKENS: ON
          DOCKER_IMAGE: centos:centos7
        run: |
          sudo mkdir -p /etc/default && sudo touch /etc/default/docker
          echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
          sudo service docker restart
          sleep 5
          sudo docker pull $DOCKER_IMAGE
